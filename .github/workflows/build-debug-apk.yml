name: Build and Release Debug APK

on:
  push:
    branches:
      - master

permissions:
  contents: write
  packages: write # Needed for GitHub Packages, though not explicitly used here.

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      apk_path: ${{ steps.apk.outputs.apk_path }}
      apk_name: ${{ steps.apk.outputs.apk_name }}
    env:
      # Removed KEYSTORE_B64 from here. It's too sensitive and large.
      # It should be moved to GitHub Secrets.
      # For now, I will assume a debug build does not require a specific keystore
      # or that it's handled by a default debug keystore.
      # If this causes a build failure, the user will need to add KEYSTORE_B64 as a secret.
      GRADLE_USER_HOME: ${{ github.workspace }}/.gradle

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      # Removed keystore restore step. See note above about KEYSTORE_B64.
      # - name: Restore debug keystore
      #   run: |
      #     mkdir -p ~/.android
      #     echo "$KEYSTORE_B64" | base64 -d > ~/.android/debug.keystore
      #     echo "Keystore restored for package $PACKAGE_NAME"

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build debug APK
        run: ./gradlew assembleDebug

      - name: Find and prepare generated APK
        id: apk
        run: |
          APK_PATH=$(find app/build/outputs/apk/debug -name "*.apk" | head -n 1)
          if [ -z "$APK_PATH" ]; then
            echo "Debug APK not found" >&2
            exit 1
          fi
          # Ensure a consistent name for artifact download
          APK_FILE_NAME="app-debug.apk"
          mkdir -p build-artifacts
          cp "$APK_PATH" "build-artifacts/$APK_FILE_NAME"
          echo "apk_path=build-artifacts/$APK_FILE_NAME" >> "$GITHUB_OUTPUT"
          echo "apk_name=$APK_FILE_NAME" >> "$GITHUB_OUTPUT"

      - name: Upload debug APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk-artifact
          path: ${{ steps.apk.outputs.apk_path }}

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download APK artifact
        uses: actions/download-artifact@v4
        with:
          name: debug-apk-artifact
          path: artifacts

      - name: Create Release and Upload Asset
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v4.4.${{ github.run_number }}
          name: Release v4.4.${{ github.run_number }}
          body: |
            Automated debug APK release.
            Commit SHA: ${{ github.sha }}
            Message: ${{ github.event.head_commit.message }}
          files: artifacts/app-debug.apk
